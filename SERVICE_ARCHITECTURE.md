# QNG Agent 服务架构

## 服务层次结构

```
┌─────────────────┐
│   Agent服务     │  (端口: 9090)
│   (UI + API)    │
└─────────┬───────┘
          │ 依赖
          ▼
┌─────────────────┐
│   MCP服务       │  (端口: 9091)
│   (统一入口)    │
└─────────┬───────┘
          │ 管理
          ▼
┌─────────────────┬─────────────────┐
│   QNG服务       │  MetaMask服务   │
│   (Chain功能)   │  (钱包功能)     │
└─────────────────┴─────────────────┘
```

## 服务职责

### 1. Agent服务 (cmd/agent/main.go)
- **端口**: 9090
- **职责**: 
  - 提供Web UI界面
  - 处理用户聊天消息
  - 管理WebSocket连接
  - 调用MCP服务执行操作

### 2. MCP服务 (cmd/mcp/main.go)
- **端口**: 9091
- **职责**:
  - 统一的服务入口
  - 管理QNG和MetaMask子服务
  - 提供HTTP API接口
  - 处理工作流调用

### 3. QNG服务 (internal/mcp/qng_server.go)
- **职责**:
  - 执行区块链工作流
  - 管理Chain功能
  - 处理交易和质押操作
  - 验证用户签名

### 4. MetaMask服务 (internal/mcp/metamask_server.go)
- **职责**:
  - 钱包连接管理
  - 交易签名处理
  - 余额查询

## 启动顺序

### 分布式模式
1. 启动MCP服务: `go run cmd/mcp/main.go`
2. 启动Agent服务: `go run cmd/agent/main.go`

### 单机模式
1. 启动主服务: `go run cmd/main.go`

## 服务依赖

- **Agent服务** → **MCP服务**
- **MCP服务** → **QNG服务** (内部)
- **MCP服务** → **MetaMask服务** (内部)
- **QNG服务** → **Chain功能** (内部)

## 注意事项

1. **Chain服务不需要独立等待**: Chain功能由QNG服务内部提供
2. **服务注册**: 只有MCP服务需要注册到服务注册中心
3. **错误处理**: 所有错误都会通过MCP服务向上传递
4. **日志记录**: 每个服务都有详细的日志记录 